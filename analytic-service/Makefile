.PHONY: help install dev run test lint format type-check clean build docker-build docker-run docker-stop docker-logs

PYTHON := python3
VENV := venv
BIN := $(VENV)/bin
APP_NAME := analytic-service

help:
	@echo "ğŸš€ Re:Path Analytics Service - Makefile Commands"
	@echo ""
	@echo "Available commands:"
	@echo "  make help         - Show this help message"
	@echo "  make install      - Create virtual environment and install dependencies"
	@echo "  make install-dev  - Install development dependencies"
	@echo "  make dev          - Run development server with hot reload"
	@echo "  make run          - Run production server"
	@echo "  make test         - Run tests with coverage"
	@echo "  make lint         - Run linting checks"
	@echo "  make format       - Format code with ruff"
	@echo "  make type-check   - Run type checking with mypy"
	@echo "  make clean        - Clean temporary files and caches"
	@echo ""
	@echo "Docker commands:"
	@echo "  make docker-build - Build Docker image"
	@echo "  make docker-run   - Run Docker container"
	@echo "  make docker-dev   - Run Docker container with hot-reload"
	@echo "  make docker-stop  - Stop Docker containers"
	@echo "  make docker-logs  - View Docker container logs"
	@echo ""

install:
	@echo "ğŸ“¦ Creating virtual environment..."
	$(PYTHON) -m venv $(VENV)
	@echo "ğŸ“¦ Installing dependencies..."
	$(BIN)/pip install --upgrade pip
	$(BIN)/pip install -r requirements.txt
	@echo "âœ… Installation complete!"
	@echo "ğŸ’¡ Activate virtual environment: source $(VENV)/bin/activate"

install-dev: install
	@echo "ğŸ“¦ Installing development dependencies..."
	$(BIN)/pip install -r requirements-dev.txt
	@echo "âœ… Development dependencies installed!"

dev:
	@echo "ğŸ”¥ Starting $(APP_NAME) in development mode with hot reload..."
	@if [ ! -d "$(VENV)" ]; then \
		echo "âŒ Virtual environment not found. Run: make install"; \
		exit 1; \
	fi
	@if [ ! -f ".env" ]; then \
		echo "âš ï¸  .env file not found. Copying from .env.example..."; \
		cp .env.example .env; \
	fi
	$(BIN)/uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

run:
	@echo "ğŸš€ Running $(APP_NAME) in production mode..."
	@if [ ! -d "$(VENV)" ]; then \
		echo "âŒ Virtual environment not found. Run: make install"; \
		exit 1; \
	fi
	@if [ ! -f ".env" ]; then \
		echo "âš ï¸  .env file not found. Copying from .env.example..."; \
		cp .env.example .env; \
	fi
	$(BIN)/uvicorn app.main:app --host 0.0.0.0 --port 8000

test:
	@echo "ğŸ§ª Running tests with coverage..."
	@if [ ! -d "$(VENV)" ]; then \
		echo "âŒ Virtual environment not found. Run: make install-dev"; \
		exit 1; \
	fi
	$(BIN)/pytest
	@echo "âœ… Tests complete!"

lint:
	@echo "ğŸ” Running linting checks..."
	@if [ ! -d "$(VENV)" ]; then \
		echo "âŒ Virtual environment not found. Run: make install-dev"; \
		exit 1; \
	fi
	$(BIN)/ruff check app tests
	@echo "âœ… Linting complete!"

format:
	@echo "âœ¨ Formatting code..."
	@if [ ! -d "$(VENV)" ]; then \
		echo "âŒ Virtual environment not found. Run: make install-dev"; \
		exit 1; \
	fi
	$(BIN)/ruff check --fix app tests
	$(BIN)/ruff format app tests
	@echo "âœ… Formatting complete!"

type-check:
	@echo "ğŸ” Running type checks..."
	@if [ ! -d "$(VENV)" ]; then \
		echo "âŒ Virtual environment not found. Run: make install-dev"; \
		exit 1; \
	fi
	$(BIN)/mypy app
	@echo "âœ… Type checking complete!"

clean:
	@echo "ğŸ§¹ Cleaning temporary files and caches..."
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".ruff_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".mypy_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete
	find . -type f -name "*.pyo" -delete
	find . -type f -name ".coverage" -delete
	rm -rf htmlcov coverage.html
	@echo "âœ… Clean complete!"

# Docker commands
docker-build:
	@echo "ğŸ³ Building Docker image..."
	docker build -t $(APP_NAME):latest .
	@echo "âœ… Docker image built!"

docker-run:
	@echo "ğŸ³ Running Docker container..."
	docker-compose up -d analytic-service
	@echo "âœ… Container started!"
	@echo "ğŸ“ Access at: http://localhost:8000"
	@echo "ğŸ“š API Docs: http://localhost:8000/docs"

docker-dev:
	@echo "ğŸ³ Running Docker container with hot-reload..."
	docker-compose --profile dev up -d analytic-service-dev
	@echo "âœ… Development container started!"
	@echo "ğŸ“ Access at: http://localhost:8001"
	@echo "ğŸ“š API Docs: http://localhost:8001/docs"

docker-stop:
	@echo "ğŸ³ Stopping Docker containers..."
	docker-compose down
	@echo "âœ… Containers stopped!"

docker-logs:
	@echo "ğŸ“œ Viewing Docker logs..."
	docker-compose logs -f analytic-service
