.PHONY: help install wire swagger build run dev test clean

BINARY_NAME=redirect-service
CMD_DIR=cmd
WIRE_DIR=cmd

help:
	@echo "ğŸš€ Re:Path Redirect Service - Makefile Commands"
	@echo ""
	@echo "Available commands:"
	@echo "  make help      - Show this help message"
	@echo "  make install   - Install dependencies and dev tools"
	@echo "  make wire      - Generate wire dependency injection"
	@echo "  make swagger   - Generate Swagger documentation"
	@echo "  make build     - Build the application"
	@echo "  make run       - Run the built application"
	@echo "  make dev       - Run with hot reload (requires air)"
	@echo "  make test      - Run tests"
	@echo "  make clean     - Clean build artifacts"
	@echo ""

install:
	@echo "ğŸ“¦ Installing dependencies..."
	go mod download
	go mod tidy
	@echo "ğŸ“¦ Installing dev tools (air + wire + swag)..."
	go install github.com/air-verse/air@latest
	go install github.com/swaggo/swag/cmd/swag@latest
	@echo "âœ… Installation complete (Wire v0.6.0 - stable)"

## Generate dependency injection dengan Wire
wire:
	@echo "âš™ï¸  Generating dependency injection with Wire..."
	cd $(WIRE_DIR) && wire
	@echo "âœ… Wire generation complete!"

## Generate Swagger documentation
swagger:
	@echo "ğŸ“š Generating Swagger documentation..."
	swag init -g $(CMD_DIR)/main.go -o docs
	@echo "âœ… Swagger docs generated at docs/"
	@echo "   Access at: http://localhost:3011/swagger/index.html"

build:
	@echo "ğŸ—ï¸  Building $(BINARY_NAME)..."
	@mkdir -p tmp
	go build -o tmp/$(BINARY_NAME) ./$(CMD_DIR)
	@echo "âœ… Build complete: tmp/$(BINARY_NAME)"

run:
	@echo "ğŸš€ Running $(BINARY_NAME)..."
	./tmp/$(BINARY_NAME)

dev:
	@echo "ğŸ”¥ Starting $(BINARY_NAME) in development mode with hot reload..."
	@if command -v air > /dev/null; then \
		air; \
	else \
		echo "âŒ Air not installed. Run: make install"; \
		exit 1; \
	fi

test:
	@echo "ğŸ§ª Running tests..."
	go test -v -race -coverprofile=coverage.out ./...
	go tool cover -html=coverage.out -o coverage.html
	@echo "âœ… Tests complete. Coverage report: coverage.html"

clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	rm -rf tmp/
	rm -f coverage.out coverage.html
	@echo "âœ… Clean complete"